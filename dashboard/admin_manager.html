<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
  </head>
<style>
html, body {
  width: 100%;
  min-width: 300px;
}

.hidden {
  display: none;
}

.button {
  margin: 3% auto;
  padding: 4px;
  text-align: center;
  font-size: 1.5em;
  cursor: pointer;
}

button {
  cursor: pointer;
}

.ulist {
  background-color: #11531f;
  color: white;
}
.ulist:hover {
  background-color: #cfeeee;
  color:#11531f
}

.cluster {
  background-color: #11531f;
  color: white;
}
.cluster:hover {
  background-color: #cfeeee;
  color:#11531f
}

.saver {
  background-color: #E5F2F2;
}
.saver:hover {
  background-color: #BFF2F2;
}


.reloader {
  background-color: #FBFBC9;
}
.reloader:hover {
  background-color: #DAEA9D;
}

.shutdown {
  background-color: #FBFBC9;
}
.shutdown:hover {
  background-color: #EAEA9D;
}


.wulist {
  background-color: #11531f;
  color: white;
}
.wulist:hover {
  background-color: #cfeeee;
  color:#11531f
}


.wsaver {
  background-color: #E5F2F2;
}
.wsaver:hover {
  background-color: #BFF2F2;
}


.wgetter {
  background-color: #FBFBC9;
}
.wgetter:hover {
  background-color: #EAEA9D;
}


.dashboard_getter {
  background-color: #FBFBC9;
  color:#064614;
}
.dashboard_getter:hover {
  background-color: #f0e19e;
  color:#053a10;
}


.help_getter {
  background-color: #FBFBC9;
  color:#064614;
}
.help_getter:hover {
  background-color: #EAEA9D;
  color:#064614;
}

.do_clear {
  color:#064614;
}
.do_clear:hover {
  background-color: #EAEA9D;
  color:#064614;
}

.do_undo {
  color:#064614;
}
.do_undo:hover {
  background-color: #EAEA9D;
  color:#064614;
}


.counter_box {
  margin-left: 4px;
  margin-right: 4px;
  padding: 2px;
  color: rgb(39, 33, 73);
  font-size: 75%;
}


 /* Style the tab */
 .tab {
  overflow: hidden;
  border: 1px solid #ccc;
  background-color: #f1f1f1;
}

/* Style the buttons that are used to open the tab content */
.tab button {
  background-color: inherit;
  float: left;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 14px 16px;
  transition: 0.3s;
}

/* Change background color of buttons on hover */
.tab button:hover {
  background-color: #ddd;
}

/* Create an active/current tablink class */
.tab button.active {
  background-color: #ccc;
}

/* Style the tab content */
.tabcontent {
  display: none;
  padding: 6px 12px;
  border: 1px solid #ccc;
  border-top: none;
} 

.tabcontent-sub {
  padding: 6px 12px;
  border: 1px solid #ccc;
  border-top: none;
} 
.PhIOtjDr_0 {
  fill:none;
  stroke:#1c1448;
  stroke-width:4.59875107;
  stroke-miterlimit:4;
  stroke-dasharray: 2948 2950;
  stroke-dashoffset: 2949;
  animation: PhIOtjDr_draw 6666ms ease-in forwards;
}

@keyframes PhIOtjDr_draw {
  100% {stroke-dashoffset: 0}
}

@keyframes PhIOtjDr_fade {
  0% {stroke-opacity: 1}
  97.1830985915493% {stroke-opacity: 1}
  100% {stroke-opacity: 0}
}

</style>
<body>
  <div id="popup-content">
    <div style="background-color: blanchedalmond;padding: 4px;border: 1px solid rgb(82, 9, 82)">
      <div style="width:38;height:38;display:inline-block">
        <a class="nav-link" href="http://www.copious.world" target="COPIOUS">
            <svg version="1.0" width="38" height="38" viewBox="0 0 250 250" preserveAspectRatio="xMidYMid meet" id="logo" >
              <defs id="defs10"/>
              <path class="PhIOtjDr_0"  id="path6" d="m 30.107062,7.4672872 c 4.67725,2.6985208 8.37554,8.6930958 12.94402,20.5087688 7.17904,19.072767 24.58277,67.337762 29.69511,82.950634 l 5.32989,15.9502 -13.70543,-0.25058 -10.468161,2.57106 -8.132079,2.99946 -4.78602,5.90784 0.76141,-6.91979 c 0.65264,-6.50536 0.32632,-7.85462 -5.43866,-25.31791 C 27.822822,80.549048 20.535012,60.127019 12.703332,40.215781 5.4155222,21.730904 4.4365622,15.57249 7.8085322,10.503124 11.941922,4.43145 22.384152,2.9954505 30.107062,7.4672872 Z M 238.08162,22.742849 c 3.69828,2.110631 6.52639,6.669206 6.52639,10.379672 0,1.686578 -2.93688,12.740881 -6.63517,24.469814 -19.68797,64.138095 -30.34775,107.931245 -30.34775,124.806655 0,4.6453 -1.08775,7.68113 -18.60024,50.80931 l -4.35093,10.79409 -67.76577,0 -67.765758,0 -14.35808,-35.35063 -14.35808,-35.3603 17.62128,-20.75934 17.5125,-20.75935 29.36879,0 c 32.631998,0 5.455822,5.28877 29.390108,7.16797 -3.81133,6.98972 7.16732,11.29772 7.16732,11.29772 l 2.51778,3.43975 c -1.74038,3.20932 -4.92039,6.69891 -9.3801,9.5709 l -3.2632,2.11064 -9.78959,-2.62144 c -8.593088,-2.27446 -11.312428,-2.61179 -22.080978,-2.61179 -13.0528,-0.0964 -14.35808,0.2506 -14.35808,4.29837 0,2.70817 3.15443,3.63336 12.72648,3.63336 21.42834,0 38.723308,8.01847 47.533928,22.10863 3.58951,5.73436 7.17904,15.86345 7.17904,20.50876 0,2.86236 4.45971,5.05973 7.50536,3.79721 2.82811,-1.09868 2.93687,-4.64531 0.65264,-14.01306 -2.28424,-9.36772 -7.83169,-17.88734 -15.77214,-24.29632 -5.32988,-4.30799 -6.30884,-5.49342 -5.11233,-6.24517 1.19649,-0.76135 2.06669,-0.51077 4.0246,1.08906 6.30885,5.23321 19.03534,7.00654 27.73719,3.88395 5.87377,-2.11064 11.85631,-7.17036 15.11951,-12.74088 1.52281,-2.53468 5.98253,-16.03694 9.89835,-29.9536 10.98611,-38.396111 22.08098,-72.320389 30.13021,-92.665317 5.54744,-14.176879 12.40016,-19.737762 23.16871,-18.812555 2.93688,0.250577 6.63517,1.175785 8.15801,2.023891 z m -126.72091,50.03831 c 2.28424,0.510792 5.76499,2.11063 7.72291,3.633367 5.87375,4.558576 6.20008,7.257098 3.80705,29.278954 -1.1965,10.71701 -1.94404,26.93071 -2.27035,27.1042 -0.32632,0.25057 -8.38942,-6.50868 -17.41761,-6.25812 l -16.533538,0.42407 0.65264,-6.66922 c 0.32632,-3.62372 1.19651,-13.83956 1.84915,-22.619385 0.65264,-9.19425 1.74037,-17.125977 2.50179,-18.561977 3.2632,-5.907835 10.550998,-8.269041 19.687958,-6.331889 z m 48.5129,9.454465 c 2.06668,1.011946 4.56848,3.209314 5.54744,4.89589 1.84914,2.871998 1.84914,4.22126 -0.8702,33.750816 -1.52282,17.04886 -3.37196,32.575 -4.24216,35.02295 -3.15442,8.51961 -9.13695,13.07819 -18.16513,13.67573 -4.78601,0.25056 -6.41762,0 -9.46327,-1.69622 -5.87376,-3.12256 -6.41764,-4.29838 -2.93689,-7.42094 6.20008,-5.744 4.00097,-11.09854 1.92352,-15.89687 0,0 -0.33391,-1.79223 -2.65798,-4.24016 l -2.01123,-1.92782 3.94219,-26.79768 c 1.95792,-22.869967 2.17547,-23.795174 5.11237,-26.667174 4.89478,-4.89589 16.96861,-6.24515 23.82134,-2.698522 z" />
              <rect style="fill:#ffffff;fill-opacity:1;stroke:none;stroke-width:4.80000019;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" id="rect4169" width="68.005806" height="55.413109" x="62.964886" y="157.3824"/>
              <rect style="opacity:1;fill:#ffffff;fill-opacity:1;stroke:none;stroke-width:1.60000002;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" id="rect4170" width="39.957146" height="46.691494" x="105.05587" y="172.33051"/>
              <rect style="opacity:1;fill:#ffffff;fill-opacity:1;stroke:none;stroke-width:2;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" id="rect4172" width="134.35677" height="7.9790406" x="49.16119" y="238.93228"/>
              <text xml:space="preserve" style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:184.28874207px;line-height:125%;font-family:'Arial Rounded MT Bold';-inkscape-font-specification:'Arial Rounded MT Bold, Normal';text-align:start;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:start;fill:#0000ff;fill-opacity:1;stroke:none;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" x="6.6644416" y="260.41125" id="text4161" transform="scale(1.041834,0.95984582)"><tspan id="tspan4163" x="6.6644416" y="260.41125">C</tspan></text>
              <text xml:space="preserve" style="font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;font-size:28.53204727px;line-height:125%;font-family:sans-serif;-inkscape-font-specification:'sans-serif, Bold';text-align:start;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:start;fill:#ff0000;fill-opacity:1;stroke:none;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" x="90" y="175.07523" id="text4165" transform="scale(0.90874022,1.1004245)"><tspan id="tspan4167" x="90" y="175.07523">opious</tspan></text>
            </svg>
        </a>
      </div>
      <div style="height:38;display:inline-block">
        <button class="ulist" onclick="fetch_user_list('user_list')">List Users</button>
        <button class="saver" onclick="backup_users()" >Backup Users</button>
        <button class="reloader" onclick="reloader_users()" >Reload</button>        
        <button class="shutdown"  onclick="shutdown_server()">Shutdown</button>        
      </div>
      <div style="background-color: blanchedalmond;padding: 4px;border: 1px solid rgb(82, 9, 82)">
        <div style="height:38;display:inline-block">
          <button class="help_getter" style="background-color:rgb(245, 255, 236);font-weight: bolder;font-size: larger;box-shadow: lightgoldenrodyellow;border-radius: 50%;">?</button>
          <button class="wulist" >ulist Window Tabs</button>
          <button class="wsaver" >Save Window</button>
          <button class="wgetter" >Retrieve Windows</button>
      </div>
      </div>
      <input id="all_tabs" type="hidden" value="" >
      <input id="window_tabs" type="hidden" value="" >
    </div>
    <div style="background-color: rgb(250, 224, 186);padding: 4px;border: 1px solid rgb(9, 32, 82)" >
        <label>Enter your email for fetching or saving:</label> <input type="email" name="uemail" id="uemail" value="$$USER_IDENTIFIER" />
    </div>
  </div>

   <!-- Tab links -->
  <div class="tab">
    <button id="pick-ulisted_tabs" class="tablinks active" >ulisted</button>
    <button id="pick-requested_topics" class="tablinks" >Topics</button>
    <button id="pick-requested_clusters" class="tablinks" >Clustering</button>
    <button id="pick-requested_domains" class="tablinks" >Domains</button>
    <button id="pick-window_ulisted" class="tablinks" >This Window Tabs</button>
    <button id="pick-requested_windows" class="tablinks" >Windows</button>
    <button id="pick-requested_help" class="tablinks" >Help</button>
  </div>

  <div id="ulisted_tabs" class="tabcontent" style="display: block;" >
      <h4>List of Users</h4>
      <div style="max-width: 300px;">Click on <b>User List</b> to list users here</div>
      <div style="grid-row: auto;height:160px;">
        <div class="tabcontent-sub" style="display:inline-block;height:150px;overflow:auto;width:40%" >
          <ul id="user_list">
            
          </ul>
        </div>
        <div class="tabcontent-sub" id="linkcontent-sub" style="display:inline-block;height:150px;overflow:auto;width:55%" >

        </div>
      </div>

      <div  class="tabcontent-sub" style="height:300px;overflow:auto" >
        Information about user <span id="user-info-id"> </span>
        <div id="user-data" class="tabcontent-sub" style="height:300px;overflow:auto" >
        </div>
      </div>
  </div>

  <div id="requested_topics" class="tabcontent" >
    <h4>List of Stored Topics</h4> 
    <div style="max-width: 300px">Click on <b>Retrieve Topics</b> to see all of the topics found in the tabs that you previously saved. 
      Results will be sorted by how many tabs they attract.</div>
    <ul id="topic_list">
        
    </ul>
  </div>

  <div id="requested_clusters" class="tabcontent" >
    <h4>List of Stored Topics</h4> 
    <div style="max-width: 300px">Enter up to five key words that you think will attract more tabs. Then, click 
      <button class="cluster" >cluster</button>
      to update your topics</div>
    <ol id="user_clusters">
        <li>
          <input id="uc_1" type="text" value = "" />
        </li>
        <li>
          <input id="uc_2" type="text" value = "" />
        </li>
        <li>
          <input id="uc_3" type="text" value = "" />
        </li>
        <li>
          <input id="uc_4" type="text" value = "" />
        </li>
        <li>
          <input id="uc_5" type="text" value = "" />
        </li>
      </ol>
  </div>


  <div id="requested_domains" class="tabcontent" >
    <h4>List of Stored Topics</h4> 
    <div style="max-width: 300px">Click on <b>Retrieve Domains</b> to see all of the topics found in the tabs that you previously saved.</div>
    <ul id="domain_list">
        
    </ul>
  </div>
 
  <div id="window_ulisted" class="tabcontent" >
    <h4>Tabs in This Window</h4> 
    <div style="max-width: 300px">Click on <b>ulist Window Tabs</b> to ulist tabs from this windows</div>
    <ul id="window_tab_list">
        
    </ul>
  </div>
 
  <div id="requested_windows" class="tabcontent" >
    <h4>List of Stored Windows</h4> 
    <div style="max-width: 300px">Click on <b>Retrieve Windows</b> to see all of the windows that you previously saved</div>
    <ul id="window_list">
        
    </ul>
  </div>

  <div id="requested_help" class="tabcontent" style="background-color: rgb(253, 245, 229);cursor:pointer">
    <h4>How to use</h4> 
    <div id="help_display" style="max-width: 300px" style="background-color: inherit;color:rgb(133, 0, 0)">
      help goes here
    </div>
  </div>
 
 

  <div id="error-content" class="hidden">
    <p>Can't access the tab-senses tool from this web page.</p><p>Try a different page.</p>
  </div>

</body>

</html>
<script>

const SERVER_PUT_TABS = "http://localhost:3111/put_tabs"
const SERVER_PUT_WINDOW = "http://localhost:3111/put_window"
const SERVER_DOMAIN_POST =  "http://localhost:3111/get_domains"
const SERVER_TOPICS_POST =  "http://localhost:3111/get_topics"
const SERVER_TOPIC_TABS_POST = "http://localhost:3111/get_topic_tabs"
const SERVER_TOPIC_LINKS_POST = "http://localhost:3111/get_link_package"
const SERVER_WINDOW_POST =  "http://localhost:3111/get_windows"
const SERVER_WINDOW_CLEAR =  "http://localhost:3111/clear"
const SERVER_WINDOW_UNDO =  "http://localhost:3111/undo"

// REAL STUFF
const SERVER_ADMIN_CMD =  "http://localhost:3111/admin/bugzy"

const DEFAULT_CLICK_CONTEXT = "domains"

let g_application_mail = false


let g_keep_data_around = {
  "windows" : "nada",
  "topics" : "nada",
  "domains" : "nada",
  "ulisted" : {
    "tab_list" : "nada",
    "window_tab_list" : "nada"
  }
}





// Generic method for querying the server ... temporary tab storage....
async function postData(url = '', data = {}, creds = 'omit', do_stringify = true, ctype) {
  let content_type = 'application/json'
  if ( ctype !== undefined ) {
      content_type = ctype
  }
  let options = {
      method: 'POST', // *GET, POST, PUT, DELETE, etc.
      mode: 'cors', // no-cors, *cors, same-origin
      cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
      credentials: creds, // include, *same-origin, omit
      headers: {
          'Content-Type': content_type
      },
      redirect: 'follow', // manual, *follow, error
      referrerPolicy: 'no-referrer', // no-referrer, *client
      body: (do_stringify ? JSON.stringify(data)  : data)	// body data type must match "Content-Type" header
  }

  if ( ctype === 'multipart/form-data') {
      delete options.headers['Content-Type']  // content type will be set automatically with a boundary
  }
  // Default options are marked with *
  const response = await fetch(url, options);
  if ( response.ok == false ) {
      console.log(response.status + ': ' + response.statusText)
      return {}
  } else {
    try {
      return await response.json(); // parses JSON response into native JavaScript objects
    } catch (e) {
      console.log(e)
      console.log(response)
      return({})
    }
  }
}



/**
 *  --  Just log the error to the console.
 */
function reportError(error) {
  console.error(`Could not come to my tab senses: ${error}`);
}




/// INTERACT WITH TABS AND TAB DB

//  logTabs 
//    -- --  display the tab information in a chosen list... 
function logTabs(tab_tables,tabs) {
  tab_tables.innerHTML = ""
  for (let tab of tabs) {
      let element = document.createElement('li')
      let h5 = document.createElement('h5')
      let dd = document.createElement('dd')
      //
      element.appendChild(h5)
      element.appendChild(dd)
      h5.innerHTML = tab.url
      dd.innerHTML = tab.title
      tab_tables.appendChild(element)
  }
}


function logList(a_tables,a_list,element_maker) {
  a_tables.innerHTML = ""
  for ( let el of a_list ) {
      let element = document.createElement('li')

      let content_el = element_maker ? element_maker(el) : false
      if ( !content_el ) {
        content_el = document.createElement('h5')
        element.appendChild(content_el)
        content_el.innerHTML = el
      }

      a_tables.appendChild(content_el)
  }
}




// ---- ---- ---- ---- ---- ---- ----
//
function insert_tabs(tab_data,tabs_stored,list_loc) {
  //
  g_keep_data_around.ulisted[list_loc] = tab_data
  //
  let message_spot = document.getElementById(list_loc)
  if ( message_spot !== undefined ) {
    //
    logTabs(message_spot,tab_data)
    //
  }

}


// ulist TABS TOGETHER... either all tabs in all windows
//                      or just tabs from the current window.


function tab_ulist(tabs,tabs_stored,list_loc) {
  //
  try {
    // // 
    let list = []
    for (let tab of tabs) {
      // tab.url requires the `tabs` permission
      list.push({"url" : tab.url, "title" : tab.title} );
    }
    // // 
    try {
      insert_tabs(list,tabs_stored,list_loc)
    } catch (ee) {
      console.log(ee)
    }
    //
  } catch (e) {
    console.log(e)
  }
}


// ---- ---- ---- ---- ---- ---- ----
//
async function do_op(op) {
  try {
    let email_in = document.getElementById('uemail')
    if ( email_in ) {
        let email = email_in.value
        if ( email.length ) {
            let postable = {
                "email" : email,
                "op" : op
            }
            try {
              let response = await postData(SERVER_TOPIC_TABS_POST + topic,postable)
              if ( response.OK === "true" ) {
                return
              }
            } catch (e) {
              alert(e)
            }
            return
        } else {
            alert("your account email is required")
        }
    }
  } catch(e) {
      alert(e)
  }
}





// // // // // // // // // // // // // // // // // // //
// // // // // // // // // // // // // // // // // // //



function logTopic(topic_tables,topics,without_filter,click_context) {

  g_keep_data_around[click_context] = topics

  topic_tables.innerHTML = ""
  for (let topic of topics) {   // these are links determined by the server; the links are to groups of tabs
    let tabs_finder = topic.link
    //
    if ( click_context === undefined ) {
      click_context = DEFAULT_CLICK_CONTEXT
    }
    //
    let element = document.createElement('li')
    let btn = document.createElement('button')
    btn.addEventListener('click',((tf) => {
        return((ev) => {
          fetch_topic(tf,without_filter)              // FETCH TOPIC fetch_topic, From a link to the server
        })
      })(tabs_finder))
    //
    let store_it = false
    if ( g_application_mail !== false && g_application_mail && g_application_mail.length ) {
        store_it = document.createElement('button')
        store_it.addEventListener('click',((tf) => {
          return(async (ev) => {
            let link_package = await fetch_topic_link_package(tf,click_context)              // FETCH TOPIC fetch_topic, From a link to the server
            if ( link_package ) {
              inject_topic_into_dashboard(tf,link_package)
            } else {
              console.log("no link package for ")
            }
          })
        })(tabs_finder))
      }
      //
      if ( store_it !== false && store_it ) {
        element.appendChild(store_it)
        store_it.innerHTML = "&#8595;"
      }

      if ( topic.count !== undefined ) {
        let counter = document.createElement('span')
        counter.className = "counter_box"
        counter.innerHTML = topic.count
        element.appendChild(counter)
      }

      element.appendChild(btn)
      btn.innerHTML = topic.descr
      topic_tables.appendChild(element)
    }
}


// retrieve the tabs that were stored given the email.
// There  are two possible post channels at the time of this writing... 
// One is for all tabs, the other is for a list of windows that were stored.
async function retrieve_tab_topics(post_channel,result_location,without_filter,context) {
  try {
    let email_in = document.getElementById('uemail')
    if ( email_in ) {
      let email = email_in.value
      email = (g_application_mail && g_application_mail.length )? g_application_mail : email
      if ( email.length  ) {
        let postable = {
            "email" : email
        }
        let response = await postData(post_channel,postable)
        if ( response.OK === "true" ) {
          let data = response.data
          let topic_spot = document.getElementById(result_location)
          if ( topic_spot ) {
            logTopic(topic_spot,data,without_filter,context)   // create buttons with links to groups of tabs
            return true
          }
        }
      } else {
          alert("your account email is required")
      }
    }
  } catch(e) {
      alert(e.message)
  }
  return false
}



// ---- ---- ---- ---- ---- ---- ---- ---- ---- ----




// STORE ... 
//

async function tab_field_saver(tab_field,post_action,opt_cluster_points) {
  //
  //let data_deposit = document.getElementById(tab_field)
  // let tab_info = data_deposit.value
  //
  let tabs_to_send = g_keep_data_around.ulisted[tab_field] 
  //
  if ( (tabs_to_send !== undefined) && tabs_to_send.length ) {
      try {
          let email_in = document.getElementById('uemail')
          if ( email_in ) {
              let email = email_in.value
              if ( email.length ) {
                  let postable = {
                      "email" : email,
                      "tabs" : tabs_to_send
                  }
                  if ( opt_cluster_points !== undefined ) {
                    postable.c_points = opt_cluster_points
                  }
                  let response = await postData(post_action,postable)
                  if ( response.OK === "true" ) {
                    let message_spot = document.getElementById("tab_list")
                    if ( message_spot ) {
                      let tab_data = [{
                        url : "tabs have been stored",
                        title : "log into your dashboard to organize your tabs at ...."
                      }]
                      logTabs(message_spot,tab_data)
                    }
                  }
                  return
              } else {
                  alert("your account email is required")
              }
          }
      } catch(e) {
          alert(e)
      }
  }

  alert("could not send data")
}


function get_cluster_point_list() {
  let points = []
  for ( let i = 0; i < 5; i++ ) {
    let c_val_holder = document.getElementById(`uc_${i+1}`)
    if ( c_val_holder ) {
      let term_point = c_val_holder.value
      term_point = term_point.trim()
      if ( term_point.length ) {
        points.push(term_point)
      }
    }
  }
  return (points.length ? points : undefined)
}

async function save_tabs(cluster_points) {
  if ( cluster_points && cluster_points.length ) {
    await tab_field_saver('tab_list',SERVER_PUT_TABS,cluster_points)
  } else {
    await tab_field_saver('tab_list',SERVER_PUT_TABS)
  }
}

/*

let cluster_points = get_cluster_point_list()

*/


async function save_window() {
}





// FETCH
//  Fetch stored data.... 





// ---- ---- ---- ---- ---- ---- ----
//
async function fetch_topic(topic,without_filter) {
  try {
    let email_in = document.getElementById('uemail')
    if ( email_in ) {
        let email = email_in.value
        if ( email.length ) {
            let postable = {
                "email" : email
            }
            try {
              let response = await postData(SERVER_TOPIC_TABS_POST + topic,postable)
              if ( response.OK === "true" ) {
                  let data = response.data
                  //spawn_tabs(data,without_filter)       // given a group of tabs has been returned, open the tabs in the current window.
              }
            } catch (e) {
              alert(e)
            }
            return
        } else {
            alert("your account email is required")
        }
    }
  } catch(e) {
      alert(e)
  }
}


// ---- ---- ---- ---- ---- ---- ----
//
async function fetch_topic_link_package(topic,click_context) {
  try {
    let email_in = document.getElementById('uemail')
    if ( email_in ) {
        let email = email_in.value
        if ( email.length ) {
            let postable = {
                "email" : email,
                "sel_topic_domain" : click_context
            }
            try {
              let response = await postData(SERVER_TOPIC_LINKS_POST + topic,postable)
              if ( response.OK === "true" ) {
                  let data = response.data    // list of link packages
                  return(data)
              }
            } catch (e) {
              alert(e)
            }
            return
        } else {
            alert("your account email is required")
        }
    }
  } catch(e) {
      alert(e)
  }
  return(false)
}


// DISPLAY STYLING...
//
function openResults(currentTarget, tabName) {
  // Declare all variables
  let tabcontent, tablinks;
  // Get all elements with class="tabcontent" and hide them
  tabcontent = document.getElementsByClassName("tabcontent");
  tablinks = document.getElementsByClassName("tablinks");

  for (let i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }

  // Get all elements with class="tablinks" and remove the class "active"
  for ( let i = 0; i < tablinks.length; i++ ) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }

  // Show the current tab, and add an "active" class to the button that opened the tab
  document.getElementById(tabName).style.display = "block";
  currentTarget.className += " active";
}


// USER INTERACTION...
//
function listenForClicks() {
  document.addEventListener("click", async (e) => {
    try {
      if (e.target.classList.contains("ulist")) {
        await ulist_tabs()
        let target =  document.getElementById("pick-ulisted_tabs")
        openResults(target, "ulisted_tabs")
        save_everything()
      } else if ( e.target.classList.contains("getter") ) {
        await retrieve_tab_topics(SERVER_TOPICS_POST,"topic_list",false,"topics")    // retrieve all tabs last stored into the server...
        let target =  document.getElementById("pick-requested_topics")
        openResults(target, "requested_topics")
        save_everything()
      } else if ( e.target.classList.contains("dgetter") ) {
        await retrieve_tab_topics(SERVER_DOMAIN_POST,"domain_list",false,"domains")    // retrieve all tabs last stored into the server...
        let target =  document.getElementById("pick-requested_domains")
        openResults(target, "requested_domains")
        save_everything()
      } else if ( e.target.classList.contains("saver") ) {
        save_tabs()   // sends tabs to the server
        let target =  document.getElementById("pick-ulisted_tabs")
        openResults(target, "ulisted_tabs")
      } else if ( e.target.classList.contains("cluster") ) {
        let cluster_points = get_cluster_point_list()
        await save_tabs(cluster_points)   // sends tabs to the server
        //
        // update the cluster display without prompting the user to do so...
        await retrieve_tab_topics(SERVER_TOPICS_POST,"topic_list",false,"topics")    // retrieve all tabs last stored into the server...
        let target =  document.getElementById("pick-requested_topics")
        openResults(target, "requested_topics")
        save_everything()
      } else if ( e.target.classList.contains("wulist") ) {
        await ulist_window_tabs()
        let target =  document.getElementById("pick-window_ulisted")
        openResults(target, "window_ulisted")
        save_everything()
      } else if ( e.target.classList.contains("wsaver") ) {
        save_window()
        let target =  document.getElementById("pick-window_ulisted")
        openResults(target, "window_ulisted") 
        save_everything()
      } else if ( e.target.classList.contains("wgetter") ) {
        await retrieve_tab_topics(SERVER_WINDOW_POST,"window_list",true,"windows")   // retrieve links to window tab sets ... tabs last stored into server...
        let target =  document.getElementById("pick-requested_windows")
        openResults(target, "requested_windows")
        save_everything()
      } else if ( e.target.classList.contains("help_getter") || ( e.target.id === "pick-requested_help" )  ) {
        show_help()
        let target =  document.getElementById("pick-requested_help")
        openResults(target, "requested_help")
      } else if ( e.target.classList.contains("tablinks") ) {  // show what's there
        let id = e.target.id
        let tartget_name = (id.split('-'))[1]
        //
        openResults(e.currentTarget, tartget_name)
      } else if ( (e.target.id === "requested_help") ) {   // turn off help and look at something else
        let target =  document.getElementById("pick-ulisted_tabs")
        openResults(target, "ulisted_tabs")
      } else if ( e.target.classList.contains("clear") ) {
        do_op("clear")
      } else if ( e.target.classList.contains("undo") ) {
        do_op("undo")
      }
    } catch (err) {
        
    }

  });
}

/**
 * There was an error executing the script.
 * Display the popup's error message, and hide the normal UI.
 */
function reportExecuteScriptError(error) {
  document.querySelector("#popup-content").classList.add("hidden");
  document.querySelector("#error-content").classList.remove("hidden");
}


// ---- ---- ---- ---- ---- ---- ----
//
async function show_help() {

}


// ---- ---- ---- ---- ---- ---- ----
//
function hide_help() {
  let help_field = document.getElementById("help_display")
  if ( help_field ) {
    help_field.innerHTML = ""
  }
}

// ---- ---- ---- ---- ---- ---- ----
//
function initialize_dashboard() {
  //
  console.log("initiaize")

  //initialize_db()

  g_application_mail = false
  //

}


// ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
//
function inject_topic_into_dashboard(package_name,link_package) {
//
}


function save_everything() {

  console.log("save_everything::  ")

  let data_to_save = JSON.stringify(g_keep_data_around)
  let email = g_application_mail
  if ( email ) {
    let storage_record = {
      "command" : "update",
      "email" : email,
      "user_tabs" : {
        "email" : email,
        "data" : data_to_save
      }
    }
    console.log("save_everything::  " + data_to_save)
    //
    //
  }
}
  
function delete_everything() {
  let email = g_application_mail
  if ( email ) {
  }
}



function load_previous(email) {
  if ( email !== false  ) {
    console.log("sending message")
  }
}

function initialize_db() {
  console.log("db initialize called")
}

/**
 * When the popup loads, inject a content script into the active tab,
 * and add a click handler.
 * If we couldn't inject the script, handle the error.
*/
listenForClicks()
initialize_dashboard()


function setup_key_event() {
  document.addEventListener("change",(ev) => {
    update_dash_link(ev)
  })
}

function update_dash_link(ev) {
  let email_src = ev.target
  if ( email_src && (email_src.id === "uemail") ) {
    let email = email_src.value
    //alert(email_src.id + " " + email)
    if ( email && email.length ) {
      let dash_link = document.getElementById("dashlink")
      if ( dash_link ) {
        dash_link.href = `http://localhost:3111/dashboard/${email}`
      }
    }
  }
}

setup_key_event() 



function make_user_active(el) {
  //id="user-info-id"
  let html_str = el
  let el_buttons = `
  <span>${el} </span>
  <button onclick="fetch_user_info('${el}')">fetch info</button> 
  <button onclick="fetch_user_domains('${el}')">domains</button> 
  <button onclick="fetch_user_topics('${el}')" >topics</button> 
  <button onclick="fetch_user_words('${el}')">words</button> 
  <button onclick="fetch_user_windows('${el}')">windows</button> 
  <button onclick="block_user('${el}')" >block</button> <button onclick="unblock_user('${el}')" >unblock</button>
  `

  let doc_el = document.createElement('blockquote')
  doc_el.innerHTML = el_buttons


  return doc_el
}


async function fetch_user_list(display_box) {
  let disp_drop = document.getElementById(display_box)
  if ( disp_drop ) {
    let postable = {
      "cmd" : "users"
    }
    let response = await postData(SERVER_ADMIN_CMD,postable)
    if ( response.OK === "true" ) {
      let ulist = response.data
      ulist = ulist.split(',')
      logList(disp_drop,ulist,make_user_active)
    }
  }
}


async function fetch_user_info(user) { // ---- ---- ---- ---- ---- ---- ---- ----
  let disp_drop = document.getElementById("user-data")
  if ( disp_drop ) {
    let postable = {
      "cmd" : "user-info",
      "user" : user
    }
    let response = await postData(SERVER_ADMIN_CMD,postable)
    if ( response.OK === "true" ) {
      let u_info = response.data
      let info_loc = document.getElementById("user-data")
      if ( info_loc ) {
        info_loc.innerHTML = u_info
      }
    }
  }

}




function show_domain_links(doml_str) {
  let link_spot = document.getElementById("linkcontent-sub")
  if ( link_spot ) {
    let url_array = doml_str.split(',')
    url_array = url_array.map(url => {
      return `<a href="${url}" target="TABS-COPIOUS-RETRIEVE">${url}</a>`
    })
    url_array = url_array.join("<br>")
    link_spot.innerHTML = url_array
  }
}


function show_word_links(doml_str) {
  let link_spot = document.getElementById("linkcontent-sub")
  if ( link_spot ) {
    let url_array = doml_str.split(',')
    url_array = url_array.map(url => {
      return `<a href="${url}" target="TABS-COPIOUS-RETRIEVE">${url}</a>`
    })
    url_array = url_array.join("<br>")
    link_spot.innerHTML = url_array
  }
}

function show_window_links(doml_str) {
  let link_spot = document.getElementById("linkcontent-sub")
  if ( link_spot ) {
    let url_array = doml_str.split(',')
    url_array = url_array.map(url => {
      return `<a href="${url}" target="TABS-COPIOUS-RETRIEVE">${url}</a>`
    })
    url_array = url_array.join("<br>")
    link_spot.innerHTML = url_array
  }
}



async function fetch_user_domains(user) {
  let disp_drop = document.getElementById("user-data")
  if ( disp_drop ) {
    let postable = {
      "cmd" : "user-domains",
      "user" : user
    }
    let response = await postData(SERVER_ADMIN_CMD,postable)
    if ( response.OK === "true" ) {
      let u_info = response.data
      let info = Object.keys(u_info)
      info = info.map(dom => {
        let dom_links = u_info[dom].join(',')
        console.log(dom_links)
        return `<button onclick="show_domain_links('${dom_links}')">${dom}</button>`
      })
      let info_loc = document.getElementById("user-data")
      if ( info_loc ) {
        info_loc.innerHTML = info.join("<br>")
      }
    }
  }
}


async function fetch_user_topics(user) {
  let disp_drop = document.getElementById("user-data")
  if ( disp_drop ) {
    let postable = {
      "cmd" : "user-topics",
      "user" : user
    }
    let response = await postData(SERVER_ADMIN_CMD,postable)
    if ( response.OK === "true" ) {
      let u_info = response.data
      let info = Object.keys(u_info)
      info = info.map(dom => {
        let dom_links = u_info[dom].join(',')
        console.log(dom_links)
        return `<button onclick="show_domain_links('${dom_links}')">${dom}</button>`
      })
      let info_loc = document.getElementById("user-data")
      if ( info_loc ) {
        info_loc.innerHTML = info.join("<br>")
      }
    }
  }
}


async function fetch_user_words(user) {
  let disp_drop = document.getElementById("user-data")
  if ( disp_drop ) {
    let postable = {
      "cmd" : "user-words",
      "user" : user
    }
    let response = await postData(SERVER_ADMIN_CMD,postable)
    if ( response.OK === "true" ) {
      let u_info = response.data
      let info = Object.keys(u_info)
      info = info.map(word => {
        let wobject = u_info[word]
        let dom_links = Object.keys(u_info[word]._url_list).join(',')
        return `<button onclick="show_word_links('${dom_links}')">${word}</button>`
      })
      let info_loc = document.getElementById("user-data")
      if ( info_loc ) {
        info_loc.innerHTML = info.join("<br>")
      }
    }
  }
}


async function fetch_user_windows(user) {

  let disp_drop = document.getElementById("user-data")
  if ( disp_drop ) {
    let postable = {
      "cmd" : "user-windows",
      "user" : user
    }
    let response = await postData(SERVER_ADMIN_CMD,postable)
    if ( response.OK === "true" ) {
      let u_info = response.data    /// an array...
      let info = u_info.map(window_descr => {
        let wtabs = window_descr.tabs
        if ( wtabs ) {
          wtabs = wtabs.map((ldescr) => {
            let link = ldescr.url
            return link
          })
          let dom_links = wtabs.join(',')
          return `<button onclick="show_window_links('${dom_links}')">${window_descr.descr}</button>`
        }
      })
      let info_loc = document.getElementById("user-data")
      if ( info_loc ) {
        info_loc.innerHTML = info.join("<br>")
      }
    }
  }
}

/*
      "welcome": {
        "_word": "welcome",
        "_count": 2,
        "_url_list": {
          "https://shop.celemony.com/cgi-bin/WebObjects/CelemonyShop.woa": "CelemonyShop | Welcome",
          "https://platform.a.team/dayone?utm_source=arcdev&utm_campaign=new&utm_medium=email": "Registration | Welcome to A.Team"
        },
        "keep": false
      },
  */



async function unblock_user(user) {
  let postable = {
      "cmd" : "unblock_user",
      "uid" : user
  }
  let response = await postData(SERVER_ADMIN_CMD,postable)
  if ( response.OK === "true" ) {
    show_status("OK")
  }
}


async function block_user(user) {
  let postable = {
      "cmd" : "block_user",
      "uid" : user
  }
  let response = await postData(SERVER_ADMIN_CMD,postable)
  if ( response.OK === "true" ) {
    show_status("OK")
  }
}

function show_status(msg) {
  //
}


async function backup_users() {
  let postable = {
      "cmd" : "backup"
    }
    let response = await postData(SERVER_ADMIN_CMD,postable)
    if ( response.OK === "true" ) {
      show_status("OK")
    }
}


async function reloader_users() {
  let postable = {
      "cmd" : "reload"
  }
  let response = await postData(SERVER_ADMIN_CMD,postable)
  if ( response.OK === "true" ) {
    show_status("OK")
  }
}

async function shutdown_server() {
  let postable = {
      "cmd" : "shutdown"
  }
  let response = await postData(SERVER_ADMIN_CMD,postable)
  if ( response.OK === "true" ) {
    show_status("OK")
  }
}

</script>
